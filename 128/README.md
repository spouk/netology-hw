# Домашнее задание к занятию 12.8. «Резервное копирование баз данных» - `Мартыненко Алексей`

### Задание 1. Резервное копирование
Кейс
Финансовая компания решила увеличить надёжность работы баз данных и их резервного копирования.
Необходимо описать, какие варианты резервного копирования подходят в случаях:


1.1. Необходимо восстанавливать данные в полном объёме за предыдущий день.

варианты в зависимости от размера базы (и еще на самом деле множества факторов, которые в постановке задачи не определены)

== если база небольшая до 50Гб, то целесообразно  делать полный бэкап ночью, с глубиной хранения 7 суток
   в зависимости от используемой субд алгоритмика формирования бэкапа будет отличаться
    в целом  
    --
    + формирование дампа с сжатием
    + передача на отдельную машину на хранение (ftp, sshfs, nfs etc...)
    + запись в лог 
    + уведомление о завершении формирования бэкапа - система мониторинга, телега etc...
        

== если размер базы > 50Гб, инкрементный - бэкапирование суточной разницы, с полным циклом повторения = 30 суток
(полный цикл = удаление полного бэкапа, формирование нового полного бэкапа)


1.2. Необходимо восстанавливать данные за час до предполагаемой поломки.

инкрементый бэкап - можно снизить частоту формирования бэкапа до 1 часа, то можно получить 
стеки бэкапов за сутки с часовой разбивкой, и в случае ЧП, можно восстановить базу до падения 
с максимальной потерей данных за -1 час на момент восстановления


    примерный алгоритм протокола формирования бэкапа бд (период ротация можно менять в зависимости от ситуации, размера базы, времени формирования полного бэкапа и других факторов)
    ---------------------------------------------------
    + формируется полный бэкап текущей базы данных
    + пишется "скрипт" на формирование инкрементного бэкапа с заданной периодичностью, в данном случае - 1 час
    + создается задача в cron'e или задача в systemd по <taskname>.timer с выполнением "скрипта"
    + результат размещается в той же директории, где и бэкап полной базы, имена суточным  бэкапам формируются по шаблона "день-месяц-год-час-минуты"
    + делается соответствующая запись в логах
    + можно добавить "оповещатель", - который будет скидывать оповещение в систему мониторинга / телегу о результатах работы
 
    примерный алгоритм протокола восстановление бд из бэкапа
    ---------------------------------------------------
    ++ реализация в виде отдельного скрипта
    + разворачивается полный бэкап 
    + файлы суточных бэкапов сортируются по дате последней модификации 
    + последовательно накатываются все инкрементные сегменты на полную версию базы
    + делается соответствующая запись в логах
    + можно добавить "оповещатель", - который будет скидывать оповещение в систему мониторинга / телегу о результатах работы

есть 2 вариант - с использованием файловых снепшотов  


1.3.* Возможен ли кейс, когда при поломке базы происходило моментальное переключение на работающую или починенную базу данных.
Приведите ответ в свободной форме. 
репликация, + можно создать HA-кластер  с 2* мастерами, сконфигурированными в режиме репликации по отношению к друг другу

### Задание 2. PostgreSQL
2.1. С помощью официальной документации приведите пример команды резервирования данных и восстановления БД (pgdump/pgrestore).
```html
pg_dump -h localhost -U postgres users > users.sql
    -h <remotehost>
    -U <username>
    users - имя бэкапируемой базы данных
    > перенаправление в выходной файл локально
    users.sql - имя бэкапа базы данных
```
```html
pg_restore -U postgres  -C -d users < users.sql
    -C d - создать новую базу данных в процессе восстановления из бэкапа при условии отсутствия такой базы
    users - имя базы данных
    users.sql - бэкап базы данных откуда происходит восстановление
```

2.1.* Возможно ли автоматизировать этот процесс? Если да, то как?
Приведите ответ в свободной форме.
да

```html
sudo crontab -e

0 0,6,12,18 * * *  pg_dump -d postgres://postgres:postgres@localhost:5432/users | zstd -o /stock/backups/users$(date +%d-%m-%Y).zst 
```


### Задание 3. MySQL
3.1. С помощью официальной документации приведите пример команды инкрементного резервного копирования базы данных MySQL.
```html
# - 1 этап полный бэкап
mysqldump --flush-logs --delete-master-logs --single-transaction --all-databases -uroot -p -hlocalhost > zstd -o /stock/backups/$(date +%d-%m-%Y_%H-%M-%S)_databases.sql
```


3.1.* В каких случаях использование реплики будет давать преимущество по сравнению с обычным резервным копированием?
Приведите ответ в свободной форме

когда базы крупные и очень крупные, и время потраченное на восстановление весьма затратно, если оценивать время простоя
сервиса*(сайта - магазин etc...) + упущенная выгода, издержки на компенсацию сорванных заказов и прочее
в этом случае наличие реплики дает страховку на  ЧП для минимизации финансовых потерь и время для сисадминов/дба 
разобрать причины падения основной базы 

